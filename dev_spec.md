## Excelフローチャート Mermaid変換ツール 開発仕様書

**文書バージョン:** 1.0
**作成日:** 2025/10/20
**作成者:** (システム管理者)

-----

## 1\. 概要

### 1.1. 目的

本仕様書は、Microsoft Excel (xlsx) ファイルとして作成されたフローチャート仕様書を、AIとPythonを組み合わせたハイブリッドアプローチにより、高精度なMermaid記法のテキストデータに変換するツールの開発仕様を定義する。

### 1.2. 開発背景と課題

Excelで作成されるフローチャートは、仕様書として多用される一方で、その構造は複雑である。
特に以下の課題が存在する。

  * **テキストと図形の分離:** 図形（ノード）内にテキストが直接記述されず、別レイヤーのテキストボックスや、枠線なしの図形がラベルとして配置されるケースが多い。
  * **OCRの限界:** 単純な画像認識（OCR）では、これらのテキストを正確に読み取れない、または、どの図形に属するテキストかを誤認識する。

### 1.3. 解決アプローチ (ハイブリッド方式)

本ツールは、AIのテキスト誤認識（OCRミス）リスクを排除し、構造認識（矢印と分岐ラベル）の精度を最大化するため、以下のハイブリッドアプローチを採用する。

1.  **[Python] データ抽出とマッピング:**
    Excelファイル（xlsx）から、全シェイプの「座標情報」と「テキスト情報」を個別に全量抽出する。座標演算（包含判定）により、「どのテキストがどの図形に属するか」を強制的にマッピングする。
2.  **[AI] 構造認識とラベル認識:**
    AI（マルチモーダルLLM）には、Pythonが生成した「ID付きアンカー画像」と「ID-テキスト対応表(JSON)」を渡す。AIはテキストの読み取りを行わず、「ID間の接続（矢印）」と「矢印に付随する分岐ラベル（Yes/Noなど）」の認識にのみ集中する。

-----

## 2\. システム構成と技術スタック

### 2.1. システム構成

本ツールは、以下のコンポーネントで構成される。

1.  **Excel解析モジュール (Python):** Excelファイルの構造を解析し、座標マッピングを行う。
2.  **資材生成モジュール (Python):** AIへの入力となる「JSON指示書」と「IDアンカー画像」を生成する。
3.  **AI連携モジュール (Python):** マルチモーダルAIのAPIを呼び出し、Mermaidコードを生成する。
4.  **マルチモーダルAI (API):** 構造認識とMermaidコード生成を担当 (例: Google Gemini, OpenAI GPT-4oなど)。

### 2.2. 使用技術スタック（推奨）

  * **言語:** Python 3.10+
  * **Excel操作:** `xlwings` または `openpyxl` (シェイプ情報へのアクセスが容易なライブラリを選定)
  * **画像処理 (アンカー画像生成):** `Pillow (PIL)`
  * **スクリーンショット (オプション):** `mss` (Excelのレンダリング結果を取得するため。`xlwings`の画像エクスポート機能で代替可能な場合あり)
  * **AI API連携:** `requests`, `google-generativeai`, `openai`

-----

## 3\. 機能要件

### FE-01: Excelデータ抽出・マッピング機能

  * **機能ID:** `FE-01`
  * **概要:** 指定されたExcelファイルの指定シートから、すべてのシェイプ情報を抽出し、座標ベースで「コンテナ図形」と「テキスト」を紐付ける。
  * **詳細仕様:** 「4.1. モジュール1: Excel解析 (`excel_parser.py`)」を参照。

### FE-02: AIインプット生成機能

  * **機能ID:** `FE-02`
  * **概要:** `FE-01`のマッピング結果に基づき、AIへの入力となる「JSON指示書」と「IDアンカー画像」を生成する。
  * **詳細仕様:** 「4.2. モジュール2: 資材生成 (`asset_generator.py`)」を参照。

### FE-03: Mermaidコード生成機能

  * **機能ID:** `FE-03`
  * **概要:** `FE-02`で生成された資材をマルチモーダルAIに送信し、Mermaidコードを取得する。
  * **詳細仕様:** 「4.3. モジュール3: AI連携 (`ai_connector.py`)」を参照。

### FE-04: 検証・修正プロセス（手動）

  * **機能ID:** `FE-04`
  * **概要:** `FE-03`で生成されたMermaidコードを人間がプレビューし、ロジック（特に分岐）の妥当性を検証・修正する。
  * **詳細仕様:** 「6. 検証プロセス (受入テスト要件)」を参照。

-----

## 4\. 詳細仕様 (モジュール定義)

### 4.1. モジュール1: Excel解析 (`excel_parser.py`)

**目的:** Excelファイルの複雑な構造を解析し、「どの図形が、どのテキストを持つか」を正確に特定する。

**開発要件:**

1.  **全シェイプ情報取得:**

      * 対象シート上のすべての `shape` オブジェクトを走査し、以下の情報を含む辞書のリスト（`all_shapes`）を作成する。
          * `temp_id`: 一時的な識別子 (例: `temp_001`)
          * `text`: `shape.text_frame.characters.text` (空文字列の場合もそのまま取得)
          * `position`: `{ "top": shape.top, "left": shape.left, "width": shape.width, "height": shape.height }`
          * `shape_type`: `shape.auto_shape_type` (例: `msoShapeRectangle`, `msoShapeFlowchartDecision`, `msoTextBox`, `msoConnectorStraight`)

2.  **役割分類:**

      * `all_shapes` リストを、以下の2つのリストに分類する。
      * **`container_shapes` (コンテナ図形リスト):**
          * フローチャートのノード（箱）となる図形。
          * **条件:** `shape_type` がテキストボックス (`msoTextBox`) やコネクタ (`msoConnector*`) **以外**の図形。
      * **`text_shapes` (テキスト図形リスト):**
          * テキストを持つ可能性のある図形（ラベル候補）。
          * **条件:** `text` が空文字列ではない、または `shape_type` が `msoTextBox` のもの。

3.  **座標マッピング処理 (核心ロジック):**

      * `container_shapes` (親) の各シェイプを基準にループする。
      * **ロジックA (自己テキスト優先):**
          * まず、`container_shape` 自身が有効なテキスト（空文字列や空白のみではない）を持つか確認する。
          * 持つ場合：そのテキストを採用し、以降のB. 包含判定処理をスキップする。
      * **ロジックB (包含判定):**
          * `container_shape` がテキストを持たない場合、`text_shapes` (子) のリストを走査する。
          * 親の座標範囲 (`parent_x1`, `parent_y1`, `parent_x2`, `parent_y2`) を計算。
          * 子の**中心座標** (`child_center_x`, `child_center_y`) を計算。
          * **判定:** 子の中心座標が、親の座標範囲内に完全に含まれている (`parent_x1 < child_center_x < parent_x2` AND `parent_y1 < child_center_y < parent_y2`) かを判定する。
          * **紐付け:** 最初に包含が確認された `text_shape` のテキストを、`container_shape['text']` に設定し、その `text_shape` を以降の走査対象から除外する（重複マッピング防止）。
          * （オプション）複数のテキストが包含される場合、最も中心が近いものを採用するロジックも検討する。

**出力:** テキスト情報がマッピングされた `container_shapes` リスト。

### 4.2. モジュール2: 資材生成 (`asset_generator.py`)

**目的:** モジュール1のマッピング結果に基づき、AIに渡す「指示書」と「参照画像」を生成する。

**開発要件:**

1.  **JSON指示書の生成 (`instructions.json`):**

      * 入力: マッピング済みの `container_shapes` リスト。
      * 処理:
          * リストを反復処理し、最終的なID (例: `node_001`, `node_002`...) を割り振る。
          * AIへの指示書となるJSONファイルを生成する。テキストが紐付かなかったコンテナも、`text: ""` としてリストに含める（AIが構造を認識するため）。
      * **JSON出力形式:**
        ```json
        [
          {
            "id": "node_001",
            "text": "受注処理開始",
            "shape_type": "msoShapeFlowchartTerminator",
            "position": { "top": 50, "left": 100, ... }
          },
          {
            "id": "node_002",
            "text": "在庫確認",
            "shape_type": "msoShapeRectangle",
            "position": { "top": 120, "left": 100, ... }
          }
          // ... 他のノードデータ ...
        ]
        ```

2.  **IDアンカー画像の生成 (`anchor_image.png`):**

      * 処理:
          * **a. 元画像の取得:** 対象のExcelフローチャート領域のスクリーンショットを取得する。(`xlwings` の `shape.export()` や `mss` ライブラリ等を利用)
          * **b. マスキング:** `instructions.json` の各シェイプ情報をループ処理する。各シェイプの `position` 情報に基づき、スクリーンショット上の該当領域を単色（例: 白）で塗りつぶす。
          * **c. ID描画:** マスキングした領域の中心に、対応する `id` (例: `node_001`) を読みやすいフォントで描画する。
          * **d. 非対象の保持:** コネクタ（矢印）や、どのコンテナにもマッピングされなかったテキスト（主に矢印のラベル "Yes"/"No"）は、マスキングや描画の対象とせず、**元の画像のまま残す**。
          * **e. 保存:** 最終的な「IDアンカー画像」をファイルとして保存する。

**出力:** `instructions.json`, `anchor_image.png`

### 4.3. モジュール3: AI連携 (`ai_connector.py`)

**目的:** 「構造（IDアンカー画像）」と「テキスト（JSON指示書）」をAIに渡し、最終的なMermaidコードを生成させる。

**開発要件:**

1.  **入力:**
      * `anchor_image.png` (画像ファイル)
      * `instructions.json` の内容 (テキスト)
2.  **プロンプト仕様:** 以下の要素を含むプロンプトを構築し、マルチモーダルAIのAPIに送信する。

<!-- end list -->

````text
あなたは、提供された画像とJSONデータからMermaidフローチャートを生成するシステムアーキテクトです。

以下の2つの情報を提供します。

【情報1：フローチャートの構造画像（ID付き）】
[ここに「IDアンカー画像」をアップロード]

* この画像は、図形の「つながり（矢印）」と「配置」を示しています。
* 各図形には `node_XXX` というIDが振られています。
* あなたのタスクは、この画像から「IDとIDのつながり（矢印）」と「矢印に付随する分岐ラベル（Yes/Noなど）」を正確に読み取ることです。

【情報2：図形の詳細データ（JSON）】
```json
[
  {
    "id": "node_001",
    "text": "受注処理開始",
    "shape_type": "msoShapeFlowchartTerminator"
  },
  {
    "id": "node_002",
    "text": "在庫確認",
    "shape_type": "msoShapeRectangle"
  },
  {
    "id": "node_003",
    "text": "在庫あり？",
    "shape_type": "msoShapeFlowchartDecision"
  }
  // ... 他のノードデータ ...
]
````

  * これは、画像内の各IDに対応する「正式なテキスト」と「図形の種類」のリストです。

【タスク】

1.  【情報1】の画像の「ID間のつながり」を視覚的に解析してください。
2.  【情報1】の画像の矢印の近くにある「分岐ラベル（"Yes", "No", "OK", "NG"など）」を読み取ってください。これらは【情報2】のJSONには含まれていません。
3.  【情報2】のJSONを使い、各IDを「正式なテキスト」と「図形の種類」にマッピングしてください。
4.  この情報を組み合わせて、完全なMermaid記法（`graph TD`）のコードを生成してください。

【Mermaid生成ルール】

  * **グラフ方向:** 常に `graph TD` （上から下）を使用します。
  * **ノード定義 (必須):**
      * `id["テキスト"]` (標準の四角形: msoShapeRectangle など)
      * `id{"テキスト"}` (ひし形: msoShapeFlowchartDecision)
      * `id(["テキスト"])` (角丸四角形: msoShapeFlowchartTerminator)
      * ※ 【情報2】の `shape_type` を参考に、Mermaidの適切な括弧（`[]`, `{}`, `()`）を使い分けてください。
  * **つながり:**
      * `id1 --> id2` (標準の矢印)
  * **分岐のラベル (最重要):**
      * ひし形（`node_003`など）からの矢印には、【情報1】の画像から読み取った分岐ラベルを必ず付与してください。
      * **書式:** `id1 -->|"ラベル"| id2`
      * **例:** `node_003 -->|"Yes"| node_004`
      * **例:** `node_003 -->|"No"| node_005`

生成したMermaidコードのみを、Markdownコードブロック（` mermaid ...  `）で出力してください。

**出力:** AIが生成したMermaidコード（テキスト）。

---

## 5. 入出力データ仕様

* **入力:**
    * `input.xlsx` (処理対象のExcelファイル)
    * `sheet_name` (処理対象のシート名)
* **中間生成物 (デバッグ・AI入力用):**
    * `instructions.json` (IDとテキストの対応表)
    * `anchor_image.png` (IDアンカー画像)
* **最終成果物:**
    * `output.md` (生成されたMermaidコードを記述したMarkdownファイル)

---

## 6. 検証プロセス (受入テスト要件)

**目的:** AIの生成したロジック（特に分岐）が、元のExcelの意図と100%一致しているか最終確認する。

**検証環境:** Mermaid Live Editor, VSCode (Markdown Preview Enhanced拡張機能) など、Mermaidを即時プレビューできる環境。

**検証項目と修正指示（フィードバック）:**

1.  **最優先：分岐ロジックの確認**
    * **確認点:** ひし形（Decision）から出る矢印のラベル（"Yes", "No", "OK", "NG"など）は正しいか？ ラベルが適用される矢印の接続先（`id --> id`）は正しいか？
    * **背景:** AIは矢印に付随する小さなテキストの認識・紐付けを最も間違えやすいため、最重要確認ポイントとなる。
    * **修正指示（AIへのフィードバック例）:**
        * 「`node_003` から `node_005` への矢印のラベルが "NG" になっていますが、正しくは "No" です。Mermaidコードを修正してください。」
        * 「`node_003` からの "Yes" の矢印は `node_004` ではなく `node_006` に接続してください。」

2.  **次点：接続（矢印）の欠落・間違い**
    * **確認点:** プレビューした図と元のExcelを見比べ、矢印が抜けている箇所はないか？ 矢印の向きが逆、または不要な矢印が生成されていないか？
    * **修正指示（例）:**
        * 「`node_007` から `node_001` へ戻る矢印（ループバック）が抜けています。`node_007 --> node_001` を追加してください。」

3.  **軽微：ノード定義の確認**
    * **確認点:** ノードの形状（四角、ひし形、角丸）は適切か？（本アプローチでは、JSONで `shape_type` を指定しているため、AIがルールを遵守すれば問題ないはず）
    * **修正指示（例）:**
        * 「`node_001` は開始ノードなので、`["テキスト"]` ではなく `(["テキスト"])` に修正してください。」
